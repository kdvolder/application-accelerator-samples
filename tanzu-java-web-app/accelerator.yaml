accelerator:
  displayName: Tanzu Java Web App - buildTool
  description: A sample Spring Boot web application built with Tanzu supply-chain
  tags:
  - java
  - spring
  - gradle
  - maven
  - web
  - tanzu
  options:
  - name: repositoryPrefix
    inputType: text
    label: Prefix for the container image repository
    defaultValue: dev.local
    required: true
  - name: buildTool
    label: Build Tool
    inputType: select
    required: true
    defaultValue: maven
    choices:
      - value: maven
        text: Maven (https://maven.apache.org/)
      - value: gradle
        text: Gradle (https://gradle.org/)
  - name: updateBoot3
    inputType: checkbox
    dataType: boolean
    label: Use Spring Boot 3.0 (Requires Java 17)
    defaultValue: false
    required: true

  imports:
  - name: java-version
  - name: tap-workload
  - name: build-wrapper-maven
  - name: build-wrapper-gradle

engine:
  let:
    - name: javaVersion
      expression: "#updateBoot3 == true ? '17' : #javaVersion"
  chain:
  - merge:
    - include: [ "**/*" ]
      exclude: [ "config/*.yaml", "Tiltfile", "README.md", "grype.yaml", "catalog/*.yaml", ".github/workflows/**" ]
    - include: [ "Tiltfile" ]
      chain:
      - type: ReplaceText
        substitutions:
        - text: tanzu-java-web-app
          with: "#artifactId.toLowerCase()"
      - type: ReplaceText
        substitutions:
        - text: your-registry.io/project
          with: "#repositoryPrefix"

    - include: [ "config/*.yaml" ]
      chain:
      - type: ReplaceText
        substitutions:
        - text: ": tanzu-java-web-app"
          with: "': ' + #artifactId.toLowerCase()"
      - merge:
        - type: InvokeFragment
          reference: tap-workload
        - include: [ "**" ]
        onConflict: UseFirst

    - include: [ "README.md" ]
      chain:
      - type: ReplaceText
        substitutions:
        - text: tanzu-java-web-app
          with: "#artifactId"

    - include: [ "catalog/*.yaml" ]
      chain:
      - type: ReplaceText
        substitutions:
        - text: tanzu-java-web-app
          with: "#artifactId"

  - merge:
    - include: [ "**" ]
    - type: InvokeFragment
      reference: java-version
    onConflict: UseLast

  # Maven build files
  - condition: "#buildTool != 'maven'"
    exclude: ["pom.xml"]
  - condition: "#buildTool == 'maven'"
    merge:
    - include: [ "**" ]
    - type: InvokeFragment
      reference: build-wrapper-maven
    onConflict: UseLast

  # Gradle build files
  - condition: "#buildTool != 'gradle'"
    exclude: ["*gradle*"]
  - condition: "#buildTool == 'gradle'"
    merge:
    - include: [ "**" ]
    - type: InvokeFragment
      reference: build-wrapper-gradle
    onConflict: UseLast

  - condition: "#updateBoot3"
    merge:
    - include: [ "**" ]
    # Maven
    - include: [ "pom.xml" ]
      chain:
      - type: OpenRewriteRecipe
        recipe: org.openrewrite.maven.ChangeParentPom
        options:
          oldGroupId: "'org.springframework.boot'"
          newGroupId: "'org.springframework.boot'"
          oldArtifactId: "'spring-boot-starter-parent'"
          newArtifactId: "'spring-boot-starter-parent'"
          newVersion: "'3.0.5'"
      - type: ReplaceText
        regex:
          pattern: "\\s+<snakeyaml.version>1.33</snakeyaml.version>"
          with: "''"
      - type: ReplaceText
        regex:
          pattern: "\\s+<spring-security.version>5.8.2</spring-security.version>"
          with: "''"
    # Gradle
    - include: [ "build.gradle.kts" ]
      chain:
      - type: ReplaceText
        regex:
          pattern: "id\\(\"org\\.springframework\\.boot\"\\) version .*"
          with: "'id(\"org.springframework.boot\") version \"3.0.5\"'"
      - type: ReplaceText
        regex:
          pattern: "id\\(\"io.spring.dependency-management\"\\) version .*"
          with: "'id(\"io.spring.dependency-management\") version \"1.1.0\"'"
      - type: ReplaceText
        regex:
          pattern: "\\s*extra\\[\"snakeyaml.version\"\\] = \"1.33\""
          with: "''"
      - type: ReplaceText
        regex:
          pattern: "\\s*extra\\[\"spring-security.version\"\\] = \"5.8.2\""
          with: "''"
    # HttpTraceRepository to HttpExchangeRepository
    - include: [ "**/*.java" ]
      chain:
      - type: ReplaceText
        regex:
          pattern: "import org\\.springframework\\.boot\\.actuate\\.trace\\.http"
          with: "'import org.springframework.boot.actuate.web.exchanges'"
      - type: ReplaceText
        regex:
          pattern: "HttpTraceRepository"
          with: "'HttpExchangeRepository'"
    onConflict: UseLast

  - type: Provenance
